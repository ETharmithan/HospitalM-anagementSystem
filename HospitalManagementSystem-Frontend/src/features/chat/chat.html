<div class="chat-container">
  <!-- Header -->
  <div class="chat-header">
    <div class="header-left">
      @if (activeView() === 'chat') {
        <button class="back-btn" (click)="showSessionList()">
          ‚Üê Back
        </button>
      }
      <h2>
        @if (activeView() === 'list') {
          Messages
        } @else if (activeView() === 'doctors') {
          Available Doctors
        } @else if (currentSession()) {
          {{ getOtherParticipantName(currentSession()!) }}
        }
      </h2>
    </div>
    <div class="header-right">
      @if (isDoctor) {
        <!-- Doctor availability toggles -->
        <div class="availability-toggles">
          <label class="toggle-label" [class.active]="myChatAvailability().isAvailableForChat">
            <input 
              type="checkbox" 
              [checked]="myChatAvailability().isAvailableForChat"
              (change)="toggleChatAvailability()">
            <span class="toggle-icon">üí¨</span>
            <span class="toggle-text">{{ myChatAvailability().isAvailableForChat ? 'Available for Chat' : 'Chat Unavailable' }}</span>
          </label>
          <label class="toggle-label" [class.active]="myChatAvailability().isAvailableForVideo">
            <input 
              type="checkbox" 
              [checked]="myChatAvailability().isAvailableForVideo"
              (change)="toggleVideoAvailability()">
            <span class="toggle-icon">üìπ</span>
            <span class="toggle-text">{{ myChatAvailability().isAvailableForVideo ? 'Available for Video' : 'Video Unavailable' }}</span>
          </label>
        </div>
      }
      @if (activeView() === 'list') {
        <button class="btn btn-primary btn-sm" (click)="showAvailableDoctors()">
          ‚ûï New Chat
        </button>
      }
      <span class="connection-status" [class.connected]="isConnected()">
        {{ isConnected() ? 'üü¢' : 'üî¥' }}
      </span>
    </div>
  </div>

  <!-- Session List View -->
  @if (activeView() === 'list') {
    <div class="session-list">
      @if (isDoctor && pendingRequests().length > 0) {
        <div class="pending-requests">
          <h3>üì® Pending Requests ({{ pendingRequests().length }})</h3>
          @for (request of pendingRequests(); track request.requestId) {
            <div class="request-card">
              <div class="request-info">
                <span class="request-patient">{{ request.patientName }}</span>
                <span class="request-type">{{ request.requestType }} Chat</span>
                <span class="request-time">{{ formatTime(request.requestedAt) }}</span>
              </div>
              @if (request.message) {
                <p class="request-message">{{ request.message }}</p>
              }
              <div class="request-actions">
                <button class="btn btn-success btn-sm" (click)="acceptRequest(request)">
                  ‚úì Accept
                </button>
                <button class="btn btn-danger btn-sm" (click)="declineRequest(request)">
                  ‚úï Decline
                </button>
              </div>
            </div>
          }
        </div>
      }

      <div class="sessions">
        <h3>üí¨ Conversations</h3>
        @if (sessions().length === 0) {
          <div class="empty-state">
            <span class="empty-icon">üí¨</span>
            <p>No conversations yet</p>
            @if (!isDoctor) {
              <button class="btn btn-primary" (click)="showAvailableDoctors()">
                Find a Doctor to Chat
              </button>
            }
          </div>
        } @else {
          @for (session of sessions(); track session.sessionId) {
            <div class="session-card" (click)="openSession(session.sessionId)">
              <div class="session-avatar">
                {{ getOtherParticipantName(session).charAt(0).toUpperCase() }}
              </div>
              <div class="session-info">
                <div class="session-name">{{ getOtherParticipantName(session) }}</div>
                <div class="session-preview">
                  @if (session.lastMessage) {
                    {{ session.lastMessage.content | slice:0:50 }}{{ session.lastMessage.content.length > 50 ? '...' : '' }}
                  } @else {
                    No messages yet
                  }
                </div>
              </div>
              <div class="session-meta">
                <span class="session-time">{{ formatDate(session.lastMessageAt) }}</span>
                @if (session.unreadCount > 0) {
                  <span class="unread-badge">{{ session.unreadCount }}</span>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>
  }

  <!-- Available Doctors View -->
  @if (activeView() === 'doctors') {
    <div class="doctors-list">
      <button class="back-link" (click)="showSessionList()">‚Üê Back to Messages</button>
      
      @if (allDoctors().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üë®‚Äç‚öïÔ∏è</span>
          <p>No doctors found</p>
          <p class="empty-hint">Please check back later</p>
        </div>
      } @else {
        <div class="doctors-grid">
          @for (doctor of allDoctors(); track doctor.doctorId) {
            <div class="doctor-card" [class.available]="doctor.isAvailableForChat || doctor.isAvailableForVideo">
              <div class="doctor-avatar">
                @if (doctor.profileImage) {
                  <img [src]="doctor.profileImage" [alt]="doctor.doctorName">
                } @else {
                  {{ doctor.doctorName.charAt(0).toUpperCase() }}
                }
                @if (doctor.isAvailableForChat || doctor.isAvailableForVideo) {
                  <span class="status-dot online"></span>
                } @else {
                  <span class="status-dot offline"></span>
                }
              </div>
              <div class="doctor-info">
                <div class="doctor-name">{{ doctor.doctorName }}</div>
                <div class="doctor-specialty">{{ doctor.specialization || 'General' }}</div>
                <div class="availability-status">
                  @if (doctor.isAvailableForChat && doctor.isAvailableForVideo) {
                    <span class="status-badge online">üü¢ Available for Chat & Video</span>
                  } @else if (doctor.isAvailableForChat) {
                    <span class="status-badge online">üü¢ Available for Chat</span>
                  } @else if (doctor.isAvailableForVideo) {
                    <span class="status-badge online">üü¢ Available for Video</span>
                  } @else {
                    <span class="status-badge offline">‚ö´ Offline - Leave a message</span>
                  }
                </div>
                @if (doctor.statusMessage) {
                  <div class="doctor-status-msg">üí¨ {{ doctor.statusMessage }}</div>
                }
              </div>
              <div class="doctor-actions">
                <button class="btn btn-primary btn-sm" (click)="startDirectChat(doctor)">
                  üí¨ Message
                </button>
                @if (doctor.isAvailableForVideo) {
                  <button class="btn btn-success btn-sm" (click)="requestChat(doctor, 'Video')">
                    üìπ Video Call
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Chat View -->
  @if (activeView() === 'chat' && currentSession()) {
    <div class="chat-view">
      <!-- Messages -->
      <div class="messages-container" #messagesContainer>
        @for (message of messages(); track message.messageId) {
          <div class="message" [class.my-message]="isMyMessage(message)" [class.other-message]="!isMyMessage(message)">
            <div class="message-content">
              <p>{{ message.content }}</p>
              <span class="message-time">
                {{ formatTime(message.sentAt) }}
                @if (isMyMessage(message)) {
                  <span class="read-status">{{ message.isRead ? '‚úì‚úì' : '‚úì' }}</span>
                }
              </span>
            </div>
          </div>
        }
        
        @if (typingUser()) {
          <div class="typing-indicator">
            <span>{{ typingUser() }} is typing...</span>
          </div>
        }
      </div>

      <!-- Video Call UI -->
      @if (isInCall()) {
        <div class="video-call-container">
          <video #remoteVideo autoplay playsinline class="remote-video"></video>
          <video #localVideo autoplay playsinline muted class="local-video"></video>
          <div class="call-controls">
            <button class="btn btn-danger" (click)="endCall()">
              üìû End Call
            </button>
          </div>
        </div>
      }

      <!-- Message Input -->
      <div class="message-input-container">
        <div class="input-actions">
          @if (currentSession()?.sessionType !== 'Text') {
            <button 
              class="btn-icon" 
              (click)="startVideoCall()" 
              [disabled]="isInCall()"
              title="Start video call">
              üìπ
            </button>
          }
        </div>
        <textarea
          [(ngModel)]="newMessage"
          (input)="onMessageInput()"
          (keypress)="onKeyPress($event)"
          placeholder="Type a message..."
          rows="1"
          class="message-input"></textarea>
        <button 
          class="send-btn" 
          (click)="sendMessage()"
          [disabled]="!newMessage().trim()">
          ‚û§
        </button>
      </div>
    </div>
  }

  <!-- Incoming Call Modal -->
  @if (incomingCall()) {
    <div class="modal-overlay">
      <div class="call-modal">
        <div class="call-icon">üìû</div>
        <h3>Incoming Video Call</h3>
        <p>{{ incomingCall()!.callerName }} is calling...</p>
        <div class="call-modal-actions">
          <button class="btn btn-success" (click)="acceptIncomingCall()">
            ‚úì Accept
          </button>
          <button class="btn btn-danger" (click)="declineIncomingCall()">
            ‚úï Decline
          </button>
        </div>
      </div>
    </div>
  }
</div>
