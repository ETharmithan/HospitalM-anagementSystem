<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <span class="badge">Super Admin</span>
        <h1>System Administration</h1>
      </div>
      <div class="header-right">
        <span class="welcome-text">Welcome, {{ userName }}</span>
        <button class="btn btn-outline" (click)="onLogout()">Logout</button>
      </div>
    </div>
  </header>

  <!-- Navigation Tabs -->
  <nav class="tabs-nav">
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'overview'"
      (click)="switchTab('overview')">
      üìä Overview
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'hospitals'"
      (click)="switchTab('hospitals')">
      üè• Hospitals
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'admins'"
      (click)="switchTab('admins')">
      üë§ Admins
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'patients'"
      (click)="switchTab('patients')">
      üßë‚Äçü§ù‚Äçüßë Patients
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'users'"
      (click)="switchTab('users')">
      üë• Users
    </button>
  </nav>

  <!-- Content Area -->
  <main class="dashboard-content">
    
    <!-- Overview Tab -->
    @if (activeTab() === 'overview') {
      <div class="stats-grid">
        @if (isLoading()) {
          @for (i of [1,2,3,4,5]; track i) {
            <div class="stat-card skeleton"></div>
          }
        } @else {
          <div class="stat-card">
            <div class="stat-icon hospitals">üè•</div>
            <div class="stat-info">
              <span class="stat-value">{{ hospitals().length }}</span>
              <span class="stat-label">Hospitals</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon users">üë•</div>
            <div class="stat-info">
              <span class="stat-value">{{ overview()?.totalUsers || 0 }}</span>
              <span class="stat-label">Total Users</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon doctors">üë®‚Äç‚öïÔ∏è</div>
            <div class="stat-info">
              <span class="stat-value">{{ overview()?.totalDoctors || 0 }}</span>
              <span class="stat-label">Doctors</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon patients">üßë‚Äçü§ù‚Äçüßë</div>
            <div class="stat-info">
              <span class="stat-value">{{ overview()?.totalPatients || 0 }}</span>
              <span class="stat-label">Patients</span>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon appointments">üìÖ</div>
            <div class="stat-info">
              <span class="stat-value">{{ overview()?.totalAppointments || 0 }}</span>
              <span class="stat-label">Appointments</span>
            </div>
          </div>
        }
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="action-buttons">
          <button class="action-btn" (click)="openCreateHospitalModal()">
            <span class="action-icon">üè•</span>
            <span>Add Hospital</span>
          </button>
          <button class="action-btn" (click)="openCreateAdminModal()">
            <span class="action-icon">üë§</span>
            <span>Add Admin</span>
          </button>
          <button class="action-btn" (click)="switchTab('hospitals')">
            <span class="action-icon">üìã</span>
            <span>Manage Hospitals</span>
          </button>
        </div>
      </div>
    }

    <!-- Hospitals Tab -->
    @if (activeTab() === 'hospitals') {
      <div class="section-header">
        <h2>Hospital Management</h2>
        <button class="btn btn-primary" (click)="openCreateHospitalModal()">
          + Add Hospital
        </button>
      </div>

      @if (isLoadingHospitals()) {
        <div class="loading-spinner">Loading hospitals...</div>
      } @else if (hospitals().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üè•</span>
          <h3>No Hospitals Yet</h3>
          <p>Create your first hospital to get started</p>
          <button class="btn btn-primary" (click)="openCreateHospitalModal()">Add Hospital</button>
        </div>
      } @else {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>City</th>
                <th>Phone</th>
                <th>Email</th>
                <th>Admins</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (hospital of hospitals(); track hospital.hospitalId) {
                <tr>
                  <td class="hospital-name">
                    <strong>{{ hospital.name }}</strong>
                    @if (hospital.address) {
                      <small>{{ hospital.address }}</small>
                    }
                  </td>
                  <td>{{ hospital.city || '-' }}</td>
                  <td>{{ hospital.phoneNumber || '-' }}</td>
                  <td>{{ hospital.email || '-' }}</td>
                  <td>
                    <span class="admin-count">{{ hospital.hospitalAdmins?.length || 0 }}</span>
                  </td>
                  <td class="actions">
                    <button class="btn-icon" title="View/Edit Hospital" (click)="viewHospitalDetails(hospital.hospitalId)">üëÅÔ∏è</button>
                    <button class="btn-icon danger" title="Delete" (click)="deleteHospital(hospital)">üóëÔ∏è</button>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    }

    <!-- Admins Tab -->
    @if (activeTab() === 'admins') {
      <div class="section-header">
        <h2>Admin Management</h2>
        <button class="btn btn-primary" (click)="openCreateAdminModal()">
          + Add Admin
        </button>
      </div>

      @if (isLoadingAdmins()) {
        <div class="loading-spinner">Loading admins...</div>
      } @else if (admins().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üë§</span>
          <h3>No Admins Yet</h3>
          <p>Create admin accounts to manage hospitals</p>
          <button class="btn btn-primary" (click)="openCreateAdminModal()">Add Admin</button>
        </div>
      } @else {
        <!-- Admins grouped by hospital -->
        @for (group of adminsByHospital(); track group.hospital) {
          <div class="admin-group">
            <div class="group-header">
              <h3>{{ group.hospital }}</h3>
              <span class="admin-count">{{ group.admins.length }} admin(s)</span>
            </div>
            <div class="cards-grid">
              @for (admin of group.admins; track admin.userId) {
                <div class="admin-card">
                  <div class="admin-avatar">{{ admin.username?.charAt(0)?.toUpperCase() || 'A' }}</div>
                  <div class="admin-info">
                    <h4>{{ admin.username }}</h4>
                    <p class="admin-email">{{ admin.email }}</p>
                    @if (admin.hospitals && admin.hospitals.length > 1) {
                      <span class="multi-hospital-badge">{{ admin.hospitals.length }} hospitals</span>
                    }
                  </div>
                  <div class="admin-actions">
                    <button class="btn-icon" (click)="editAdmin(admin)" title="Edit Admin">
                      ‚úèÔ∏è
                    </button>
                    <button class="btn-icon btn-danger" (click)="deleteAdmin(admin)" title="Delete Admin">
                      üóëÔ∏è
                    </button>
                  </div>
                </div>
              }
            </div>
          </div>
        }
      }
    }

    <!-- Patients Tab -->
    @if (activeTab() === 'patients') {
      <div class="section-header">
        <h2>Patient Management</h2>
        <span class="admin-count">{{ patients().length }} patients</span>
      </div>

      @if (isLoadingPatients()) {
        <div class="loading-spinner">Loading patients...</div>
      } @else if (patients().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üßë‚Äçü§ù‚Äçüßë</span>
          <h3>No Patients Yet</h3>
          <p>No patients registered in the system</p>
        </div>
      } @else {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Phone</th>
                <th>NIC</th>
                <th>Location</th>
                <th>Appointments</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (patient of patients(); track patient.patientId) {
                <tr>
                  <td>{{ patient.firstName }} {{ patient.lastName }}</td>
                  <td>{{ patient.email }}</td>
                  <td>{{ patient.phoneNumber }}</td>
                  <td>{{ patient.nic }}</td>
                  <td>{{ patient.city }}, {{ patient.province }}</td>
                  <td>{{ patient.appointmentCount }}</td>
                  <td>
                    <div class="actions">
                      <button class="btn-icon danger" (click)="deletePatient(patient)" title="Delete Patient">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    }

    <!-- Users Tab -->
    @if (activeTab() === 'users') {
      <div class="section-header">
        <h2>User Management</h2>
        <span class="admin-count">{{ filteredAndSortedUsers().length }} / {{ users().length }} users</span>
      </div>

      <!-- Filter and Sort Controls -->
      <div class="filter-controls">
        <div class="search-box">
          <input 
            type="text" 
            placeholder="Search by username or email..." 
            [(ngModel)]="userSearchTerm"
            (ngModelChange)="userSearchTerm.set($event)"
            class="search-input">
        </div>
        
        <div class="filter-group">
          <label>Role:</label>
          <select [(ngModel)]="userRoleFilter" (ngModelChange)="userRoleFilter.set($event)" class="filter-select">
            <option value="all">All Roles</option>
            <option value="SuperAdmin">SuperAdmin</option>
            <option value="Admin">Admin</option>
            <option value="Doctor">Doctor</option>
            <option value="Patient">Patient</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Sort By:</label>
          <select [(ngModel)]="userSortBy" (ngModelChange)="userSortBy.set($event)" class="filter-select">
            <option value="username">Username</option>
            <option value="role">Role</option>
          </select>
        </div>

        <div class="filter-group">
          <button 
            class="btn-sort" 
            (click)="userSortOrder.set(userSortOrder() === 'asc' ? 'desc' : 'asc')"
            [title]="userSortOrder() === 'asc' ? 'Ascending' : 'Descending'">
            {{ userSortOrder() === 'asc' ? '‚Üë' : '‚Üì' }}
          </button>
        </div>
      </div>

      @if (isLoadingUsers()) {
        <div class="loading-spinner">Loading users...</div>
      } @else if (filteredAndSortedUsers().length === 0 && users().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üë•</span>
          <h3>No Users Yet</h3>
          <p>No users registered in the system</p>
        </div>
      } @else if (filteredAndSortedUsers().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üîç</span>
          <h3>No Results Found</h3>
          <p>No users match your current filters</p>
        </div>
      } @else {
        <div class="table-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Username</th>
                <th>Email</th>                
                <th>Role</th>
                <th>Email Verified</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              @for (user of filteredAndSortedUsers(); track user.userId) {
                <tr>
                  <td>{{ user.username }}</td>
                  <td>{{ user.email }}</td>
                  <td>
                    <span class="role-badge" [class]="user.role.toLowerCase()">
                      {{ user.role }}
                    </span>
                  </td>
                  <td>
                    <span [style.color]="user.isEmailVerified ? '#4caf50' : '#f44336'">
                      {{ user.isEmailVerified ? '‚úì Verified' : '‚úó Not Verified' }}
                    </span>
                  </td>
                  <td>
                    <div class="actions">
                      <button class="btn-icon danger" (click)="deleteUser(user)" title="Delete User">
                        üóëÔ∏è
                      </button>
                    </div>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    }
  </main>

  <!-- Hospital Modal -->
  @if (showHospitalModal()) {
    <div class="modal-overlay" (click)="closeHospitalModal()">
      <div class="modal modal--wide" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>{{ editingHospital() ? 'Edit Hospital' : 'Add New Hospital' }}</h2>
          <button class="close-btn" (click)="closeHospitalModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Hospital Name *</label>
            <input type="text" [(ngModel)]="hospitalForm.name" placeholder="Enter hospital name">
          </div>

          <div class="location-tools">
            <div class="form-group location-search">
              <label>Find Location</label>
              <input
                type="text"
                [ngModel]="locationSearchQuery()"
                (ngModelChange)="onLocationSearchInput($event)"
                placeholder="Search place / address..."
                autocomplete="off"
              >

              @if (showLocationResults()) {
                <div class="location-results">
                  @if (isSearchingLocation()) {
                    <div class="location-result-item muted">Searching...</div>
                  } @else if (locationSearchResults().length === 0) {
                    <div class="location-result-item muted">No results</div>
                  } @else {
                    @for (r of locationSearchResults(); track r.displayName) {
                      <button type="button" class="location-result-item" (click)="selectLocationResult(r)">
                        {{ r.displayName }}
                      </button>
                    }
                  }
                </div>
              }
            </div>

            <div class="location-actions">
              <button class="btn btn-outline" type="button" (click)="useCurrentLocation()" [disabled]="isUsingCurrentLocation()">
                {{ isUsingCurrentLocation() ? 'Locating...' : 'Use Current Location' }}
              </button>
              <button class="btn btn-outline" type="button" (click)="clearLocationSearch()">
                Clear
              </button>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Address *</label>
              <input type="text" [(ngModel)]="hospitalForm.address" placeholder="Street address">
            </div>
            <div class="form-group">
              <label>City *</label>
              <input type="text" [(ngModel)]="hospitalForm.city" placeholder="City">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>State/Province *</label>
              <input type="text" [(ngModel)]="hospitalForm.state" placeholder="State">
            </div>
            <div class="form-group">
              <label>Country *</label>
              <input type="text" [(ngModel)]="hospitalForm.country" placeholder="Country">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Latitude</label>
              <input type="number" [(ngModel)]="hospitalForm.latitude" placeholder="e.g. 6.9271" step="any">
            </div>
            <div class="form-group">
              <label>Longitude</label>
              <input type="number" [(ngModel)]="hospitalForm.longitude" placeholder="e.g. 79.8612" step="any">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Postal Code *</label>
              <input type="text" [(ngModel)]="hospitalForm.postalCode" placeholder="Postal code">
            </div>
            <div class="form-group">
              <label>Phone *</label>
              <input type="tel" [(ngModel)]="hospitalForm.phoneNumber" placeholder="Phone number">
            </div>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="hospitalForm.email" placeholder="Email address">
          </div>
          <div class="form-group">
            <label>Website</label>
            <input type="url" [(ngModel)]="hospitalForm.website" placeholder="https://...">
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea [(ngModel)]="hospitalForm.description" placeholder="Brief description..." rows="3"></textarea>
          </div>

          @if (getHospitalMapsEmbedUrl(); as mapUrl) {
            <div class="map-preview">
              <div class="map-preview-header">
                <div class="map-preview-title">Location Preview</div>
                <a class="btn btn-outline" [href]="getHospitalMapsSearchUrl()" target="_blank" rel="noopener noreferrer">
                  Open in Google Maps
                </a>
              </div>
              <div class="map-preview-frame">
                <iframe
                  [src]="mapUrl"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                  title="Hospital Location Preview"
                ></iframe>
              </div>
            </div>
          }
          
          <!-- Admin section for new hospital -->
          @if (!editingHospital()) {
            <div class="admin-section">
              <h3>Hospital Admin (Required)</h3>
              <p class="form-hint">Create an admin account to manage this hospital</p>
              <div class="form-group">
                <label>Admin Name *</label>
                <input type="text" [(ngModel)]="hospitalAdminForm.displayName" placeholder="Enter admin full name">
              </div>
              <div class="form-group">
                <label>Admin Email *</label>
                <input type="email" [(ngModel)]="hospitalAdminForm.email" placeholder="admin@example.com">
              </div>
              <div class="form-group">
                <label>Admin Password *</label>
                <input type="password" [(ngModel)]="hospitalAdminForm.password" placeholder="Minimum 8 characters">
              </div>
            </div>
          }
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="closeHospitalModal()">Cancel</button>
          <button class="btn btn-primary" (click)="saveHospital()" [disabled]="isSubmitting()">
            {{ isSubmitting() ? 'Saving...' : (editingHospital() ? 'Update' : 'Create Hospital & Admin') }}
          </button>
        </div>
      </div>
    </div>
  }

  <!-- Admin Modal -->
  @if (showAdminModal()) {
    <div class="modal-overlay" (click)="closeAdminModal()">
      <div class="modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h2>Create New Admin</h2>
          <button class="close-btn" (click)="closeAdminModal()">√ó</button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Select Hospital *</label>
            @if (isLoadingHospitals()) {
              <select disabled>
                <option>Loading hospitals...</option>
              </select>
            } @else if (hospitals().length === 0) {
              <select disabled>
                <option>No hospitals available. Create a hospital first.</option>
              </select>
            } @else {
              <select [(ngModel)]="adminForm.hospitalId">
                <option value="">-- Select a Hospital --</option>
                @for (hospital of hospitals(); track hospital.hospitalId) {
                  <option [value]="hospital.hospitalId">{{ hospital.name }}</option>
                }
              </select>
            }
          </div>
          <div class="form-group">
            <label>Full Name *</label>
            <input type="text" [(ngModel)]="adminForm.displayName" placeholder="Enter full name">
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="adminForm.email" placeholder="admin@example.com">
          </div>
          <div class="form-group">
            <label>Password *</label>
            <input type="password" [(ngModel)]="adminForm.password" placeholder="Minimum 8 characters">
          </div>
          <p class="form-hint">The admin will be assigned to the selected hospital and will receive an email to verify their account.</p>
        </div>
        <div class="modal-footer">
          <button class="btn btn-outline" (click)="closeAdminModal()">Cancel</button>
          <button class="btn btn-primary" (click)="createAdmin()" [disabled]="isSubmitting()">
            {{ isSubmitting() ? 'Creating...' : 'Create Admin' }}
          </button>
        </div>
      </div>
    </div>
  }

</div>
