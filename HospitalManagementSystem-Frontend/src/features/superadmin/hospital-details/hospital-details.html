<app-nav></app-nav>
<div class="hospital-details-container">
  <div class="header">
    <button class="back-btn" (click)="goBack()">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 12H5M12 19l-7-7 7-7"/>
      </svg>
      Back to Dashboard
    </button>
    @if (!isLoading() && hospitalDetails()) {
      <div class="header-info">
        <h1>{{ hospitalDetails()!.name }}</h1>
        <span class="status-badge" [class.active]="hospitalDetails()!.isActive">
          {{ hospitalDetails()!.isActive ? 'Active' : 'Inactive' }}
        </span>
      </div>
    }
  </div>

  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading hospital details...</p>
    </div>
  }

  @if (!isLoading() && hospitalDetails()) {
    <!-- Statistics Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon departments">üè•</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.totalDepartments }}</span>
          <span class="stat-label">Departments</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon doctors">üë®‚Äç‚öïÔ∏è</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.totalDoctors }}</span>
          <span class="stat-label">Doctors</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon admins">üë§</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.totalAdmins }}</span>
          <span class="stat-label">Admins</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon bookings">üìÖ</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.totalBookings }}</span>
          <span class="stat-label">Total Bookings</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon upcoming">üîî</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.upcomingBookings }}</span>
          <span class="stat-label">Upcoming</span>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon completed">‚úÖ</div>
        <div class="stat-info">
          <span class="stat-value">{{ hospitalDetails()!.completedBookings }}</span>
          <span class="stat-label">Completed</span>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn" [class.active]="activeTab() === 'overview'" (click)="setActiveTabExtended('overview')">
        Overview
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'departments'" (click)="setActiveTabExtended('departments')">
        Departments ({{ hospitalDetails()!.totalDepartments }})
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'doctors'" (click)="setActiveTabExtended('doctors')">
        Doctors ({{ hospitalDetails()!.totalDoctors }})
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'admins'" (click)="setActiveTabExtended('admins')">
        Admins ({{ hospitalDetails()!.totalAdmins }})
      </button>
      <button class="tab-btn" [class.active]="activeTab() === 'bookings'" (click)="setActiveTabExtended('bookings')">
        Bookings
      </button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
      <!-- Overview Tab -->
      @if (activeTab() === 'overview') {
        <div class="overview-section">
          <div class="info-card">
            <h2>Hospital Information</h2>
            <div class="info-grid">
              <div class="info-item">
                <span class="label">Address:</span>
                <span class="value">{{ hospitalDetails()!.address }}</span>
              </div>
              <div class="info-item">
                <span class="label">City:</span>
                <span class="value">{{ hospitalDetails()!.city }}</span>
              </div>
              <div class="info-item">
                <span class="label">State:</span>
                <span class="value">{{ hospitalDetails()!.state }}</span>
              </div>
              <div class="info-item">
                <span class="label">Country:</span>
                <span class="value">{{ hospitalDetails()!.country }}</span>
              </div>
              <div class="info-item">
                <span class="label">Postal Code:</span>
                <span class="value">{{ hospitalDetails()!.postalCode }}</span>
              </div>
              <div class="info-item">
                <span class="label">Phone:</span>
                <span class="value">{{ hospitalDetails()!.phoneNumber }}</span>
              </div>
              <div class="info-item">
                <span class="label">Email:</span>
                <span class="value">{{ hospitalDetails()!.email }}</span>
              </div>
              @if (hospitalDetails()!.website) {
                <div class="info-item">
                  <span class="label">Website:</span>
                  <span class="value">
                    <a [href]="hospitalDetails()!.website" target="_blank">{{ hospitalDetails()!.website }}</a>
                  </span>
                </div>
              }
              <div class="info-item full-width">
                <span class="label">Created:</span>
                <span class="value">{{ hospitalDetails()!.createdAt | date:'medium' }}</span>
              </div>
              @if (hospitalDetails()!.description) {
                <div class="info-item full-width">
                  <span class="label">Description:</span>
                  <span class="value">{{ hospitalDetails()!.description }}</span>
                </div>
              }
            </div>
          </div>

          <div class="info-card location-card">
            <div class="location-header">
              <h2>Location</h2>
              <div class="location-header-actions">
                <a class="map-link" [href]="getHospitalMapsSearchUrl()" target="_blank" rel="noopener">
                  Open in Google Maps
                </a>
                @if (!isEditingLocation()) {
                  <button class="location-btn" type="button" (click)="startEditLocation()">Edit</button>
                }
              </div>
            </div>

            <div class="location-address">
              {{ hospitalDetails()!.address }}, {{ hospitalDetails()!.city }}, {{ hospitalDetails()!.state }}, {{ hospitalDetails()!.country }} {{ hospitalDetails()!.postalCode }}
            </div>

            @if (getHospitalMapsEmbedUrl(); as mapUrl) {
              <div class="map-preview-frame">
                <iframe
                  [src]="mapUrl"
                  loading="lazy"
                  referrerpolicy="no-referrer-when-downgrade"
                  allowfullscreen
                  title="Hospital Location"
                ></iframe>
              </div>
            }

            @if (isEditingLocation()) {
              <div class="location-editor">
                <div class="location-search">
                  <label>Search Location</label>
                  <input
                    type="text"
                    [ngModel]="locationSearchQuery()"
                    (ngModelChange)="onLocationSearchInput($event)"
                    placeholder="Search place / address..."
                    autocomplete="off"
                  >

                  @if (showLocationResults()) {
                    <div class="location-results">
                      @if (isSearchingLocation()) {
                        <div class="location-result-item muted">Searching...</div>
                      } @else if (locationSearchResults().length === 0) {
                        <div class="location-result-item muted">No results</div>
                      } @else {
                        @for (r of locationSearchResults(); track r.displayName) {
                          <button type="button" class="location-result-item" (click)="selectLocationResult(r)">
                            {{ r.displayName }}
                          </button>
                        }
                      }
                    </div>
                  }
                </div>

                <div class="location-editor-row">
                  <div class="form-group">
                    <label>Latitude</label>
                    <input type="number" [ngModel]="editLatitude()" (ngModelChange)="editLatitude.set($event)" step="any" placeholder="e.g. 6.9271">
                  </div>
                  <div class="form-group">
                    <label>Longitude</label>
                    <input type="number" [ngModel]="editLongitude()" (ngModelChange)="editLongitude.set($event)" step="any" placeholder="e.g. 79.8612">
                  </div>
                </div>

                <div class="location-editor-actions">
                  <button class="location-btn" type="button" (click)="clearLocationSearch()">Clear Search</button>
                  <button class="location-btn location-btn--danger" type="button" (click)="clearPin()" [disabled]="isSavingLocation()">Clear Pin</button>
                  <button class="location-btn" type="button" (click)="cancelEditLocation()" [disabled]="isSavingLocation()">Cancel</button>
                  <button class="location-btn location-btn--primary" type="button" (click)="saveLocation()" [disabled]="isSavingLocation()">
                    {{ isSavingLocation() ? 'Saving...' : 'Save' }}
                  </button>
                </div>
              </div>
            }
          </div>
        </div>
      }

      <!-- Doctors Tab -->
      @if (activeTab() === 'doctors') {
        <div class="doctors-section">
          @if (isLoadingDoctors()) {
            <div class="loading-container">
              <div class="spinner"></div>
              <p>Loading doctors...</p>
            </div>
          } @else if (doctors().length === 0) {
            <div class="empty-state">
              <span class="empty-icon">üë®‚Äç‚öïÔ∏è</span>
              <h3>No Doctors</h3>
              <p>This hospital doesn't have any doctors assigned yet.</p>
            </div>
          } @else {
            <div class="cards-grid">
              @for (doctor of doctors(); track doctor.doctorId) {
                <div class="doctor-card">
                  <div class="doctor-avatar">{{ doctor.name.charAt(0).toUpperCase() }}</div>
                  <div class="doctor-info">
                    <h3>{{ doctor.name }}</h3>
                    <p>{{ doctor.email }}</p>
                    <p class="muted">{{ doctor.departmentName || 'N/A' }} ‚Ä¢ {{ doctor.qualification }}</p>
                    <span class="status-pill" [class.active]="doctor.status?.toLowerCase() === 'active'">
                      {{ doctor.status }}
                    </span>
                  </div>
                  <a class="view-btn" [routerLink]="['/doctor-detail', doctor.doctorId]">View</a>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Departments Tab -->
      @if (activeTab() === 'departments') {
        <div class="departments-section">
          @if (hospitalDetails()!.departments.length === 0) {
            <div class="empty-state">
              <span class="empty-icon">üè•</span>
              <h3>No Departments</h3>
              <p>This hospital doesn't have any departments yet.</p>
            </div>
          } @else {
            <div class="cards-grid">
              @for (dept of hospitalDetails()!.departments; track dept.departmentId) {
                <div class="department-card">
                  <h3>{{ dept.name }}</h3>
                  @if (dept.description) {
                    <p class="description">{{ dept.description }}</p>
                  }
                  <div class="department-stats">
                    <span class="stat">
                      <span class="icon">üë®‚Äç‚öïÔ∏è</span>
                      {{ dept.doctorCount }} {{ dept.doctorCount === 1 ? 'Doctor' : 'Doctors' }}
                    </span>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Admins Tab -->
      @if (activeTab() === 'admins') {
        <div class="admins-section">
          @if (hospitalDetails()!.admins.length === 0) {
            <div class="empty-state">
              <span class="empty-icon">üë§</span>
              <h3>No Admins</h3>
              <p>This hospital doesn't have any admins assigned yet.</p>
            </div>
          } @else {
            <div class="cards-grid">
              @for (admin of hospitalDetails()!.admins; track admin.userId) {
                <div class="admin-card">
                  <div class="admin-avatar">{{ admin.username.charAt(0).toUpperCase() }}</div>
                  <div class="admin-info">
                    <h3>{{ admin.username }}</h3>
                    <p>{{ admin.email }}</p>
                    <span class="status-badge" [class.active]="admin.isActive">
                      {{ admin.isActive ? 'Active' : 'Inactive' }}
                    </span>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }

      <!-- Bookings Tab -->
      @if (activeTab() === 'bookings') {
        <div class="bookings-section">
          <div class="booking-stats-grid">
            <div class="booking-stat-card upcoming">
              <div class="stat-header">
                <span class="icon">üîî</span>
                <h3>Upcoming Bookings</h3>
              </div>
              <div class="stat-number">{{ hospitalDetails()!.upcomingBookings }}</div>
            </div>
            <div class="booking-stat-card completed">
              <div class="stat-header">
                <span class="icon">‚úÖ</span>
                <h3>Completed Bookings</h3>
              </div>
              <div class="stat-number">{{ hospitalDetails()!.completedBookings }}</div>
            </div>
            <div class="booking-stat-card cancelled">
              <div class="stat-header">
                <span class="icon">‚ùå</span>
                <h3>Cancelled Bookings</h3>
              </div>
              <div class="stat-number">{{ hospitalDetails()!.cancelledBookings }}</div>
            </div>
          </div>
        </div>
      }
    </div>
  }
</div>
