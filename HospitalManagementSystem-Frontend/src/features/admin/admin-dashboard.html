<div class="admin-dashboard">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <div class="logo">
        <span class="logo-icon">üè•</span>
        <span class="logo-text">Hospital Admin</span>
      </div>
    </div>
    
    <nav class="sidebar-nav">
      <button class="nav-item" [class.active]="activeTab() === 'overview'" (click)="setActiveTab('overview')">
        <span class="nav-icon">üìä</span>
        <span>Overview</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'doctors'" (click)="setActiveTab('doctors')">
        <span class="nav-icon">üë®‚Äç‚öïÔ∏è</span>
        <span>Doctors</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'schedules'" (click)="setActiveTab('schedules')">
        <span class="nav-icon">üïí</span>
        <span>Doctor Availability</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'departments'" (click)="setActiveTab('departments')">
        <span class="nav-icon">üè¢</span>
        <span>Departments</span>
      </button>
      <button class="nav-item" [class.active]="activeTab() === 'appointments'" (click)="setActiveTab('appointments')">
        <span class="nav-icon">üìÖ</span>
        <span>Appointments</span>
      </button>
    </nav>
    
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar">{{ currentUser()?.displayName?.charAt(0) || 'A' }}</div>
        <div class="user-details">
          <span class="user-name">{{ currentUser()?.displayName || 'Admin' }}</span>
          <span class="user-role">Hospital Admin</span>
        </div>
      </div>
      <button class="logout-btn" (click)="logout()">
        <span>üö™</span> Logout
      </button>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Header -->
    <header class="content-header">
      <div class="header-left">

        @if (hospitalInfo()) {
          <p class="page-subtitle">{{ hospitalInfo()!.hospitalName }} - {{ hospitalInfo()!.hospitalCity }}</p>
        } @else {
          <p class="page-subtitle">Manage your hospital operations efficiently</p>
        }
                <h1 class="page-title">
          @switch (activeTab()) {
            @case ('overview') { Dashboard Overview }
            @case ('doctors') { Doctor Management }
            @case ('schedules') { Availability Management }
            @case ('departments') { Department Management }
            @case ('appointments') { Appointments }
          }
        </h1>
      </div>
      <div class="header-right">
        @if (activeTab() === 'doctors') {
          <button class="btn btn-primary" (click)="openCreateDoctorModal()">
            <span>+</span> Add Doctor
          </button>
        }
        @if (activeTab() === 'departments') {
          <button class="btn btn-primary" (click)="openCreateDepartmentModal()">
            <span>+</span> Add Department
          </button>
        }
      </div>
    </header>

    <!-- Content Area -->
    <div class="content-area">
      <!-- Overview Tab -->
      @if (activeTab() === 'overview') {
        @if (isLoading()) {
          <div class="loading-grid">
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
            <div class="skeleton-card"></div>
          </div>
        } @else if (errorMessage()) {
          <div class="error-card">
            <span class="error-icon">‚ö†Ô∏è</span>
            <h3>Error Loading Data</h3>
            <p>{{ errorMessage() }}</p>
          </div>
        } @else {
          <div class="stats-grid">
            <div class="stat-card stat-users">
              <div class="stat-icon">üë•</div>
              <div class="stat-info">
                <span class="stat-value">{{ overview()?.totalUsers || 0 }}</span>
                <span class="stat-label">Total Users</span>
              </div>
            </div>
            <div class="stat-card stat-doctors">
              <div class="stat-icon">üë®‚Äç‚öïÔ∏è</div>
              <div class="stat-info">
                <span class="stat-value">{{ overview()?.totalDoctors || 0 }}</span>
                <span class="stat-label">Doctors</span>
              </div>
            </div>
            <div class="stat-card stat-patients">
              <div class="stat-icon">üèÉ</div>
              <div class="stat-info">
                <span class="stat-value">{{ overview()?.totalPatients || 0 }}</span>
                <span class="stat-label">Patients</span>
              </div>
            </div>
            <div class="stat-card stat-appointments">
              <div class="stat-icon">üìÖ</div>
              <div class="stat-info">
                <span class="stat-value">{{ overview()?.totalAppointments || 0 }}</span>
                <span class="stat-label">Appointments</span>
              </div>
            </div>
            <div class="stat-card stat-departments">
              <div class="stat-icon">üè¢</div>
              <div class="stat-info">
                <span class="stat-value">{{ overview()?.totalDepartments || 0 }}</span>
                <span class="stat-label">Departments</span>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="section">
            <h2 class="section-title">Quick Actions</h2>
            <div class="quick-actions">
              <button class="action-card" (click)="setActiveTab('doctors'); openCreateDoctorModal()">
                <span class="action-icon">üë®‚Äç‚öïÔ∏è</span>
                <span class="action-text">Add New Doctor</span>
              </button>
              <button class="action-card" (click)="setActiveTab('departments'); openCreateDepartmentModal()">
                <span class="action-icon">üè¢</span>
                <span class="action-text">Add Department</span>
              </button>
              <button class="action-card" (click)="setActiveTab('appointments')">
                <span class="action-icon">üìÖ</span>
                <span class="action-text">View Appointments</span>
              </button>
            </div>
          </div>
        }
      }

      <!-- Doctors Tab -->
      @if (activeTab() === 'doctors') {
        @if (isLoadingDoctors()) {
          <div class="loading-spinner">Loading doctors...</div>
        } @else if (doctors().length === 0) {
          <div class="empty-state">
            <span class="empty-icon">üë®‚Äç‚öïÔ∏è</span>
            <h3>No Doctors Yet</h3>
            <p>Add your first doctor to get started</p>
            <button class="btn btn-primary" (click)="openCreateDoctorModal()">Add Doctor</button>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Doctor</th>
                  <th>Department</th>
                  <th>Contact</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (doctor of doctors(); track doctor.doctorId) {
                  <tr>
                    <td>
                      <div class="doctor-info">
                        <div class="doctor-avatar">{{ doctor.name?.charAt(0) || 'D' }}</div>
                        <div>
                          <div class="doctor-name">Dr. {{ doctor.name }}</div>
                          <div class="doctor-qualification">{{ doctor.qualification || 'N/A' }}</div>
                        </div>
                      </div>
                    </td>
                    <td>{{ doctor.departmentName || 'Unassigned' }}</td>
                    <td>
                      <div class="contact-info">
                        <div>{{ doctor.email }}</div>
                        <div class="phone">{{ doctor.phone || 'N/A' }}</div>
                      </div>
                    </td>
                    <td>
                      <span class="status-badge" [class.active]="doctor.status === 'Active'">
                        {{ doctor.status || 'Active' }}
                      </span>
                    </td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn-icon" title="Manage Schedule" (click)="openScheduleModal(doctor)">üìÖ</button>
                        <button class="btn-icon" title="Edit" (click)="openEditDoctorModal(doctor)">‚úèÔ∏è</button>
                        <button class="btn-icon btn-danger" title="Delete" (click)="deleteDoctor(doctor)">üóëÔ∏è</button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      }

      <!-- Availability / Schedules Tab -->
      @if (activeTab() === 'schedules') {
        @if (isLoadingDoctors()) {
          <div class="loading-spinner">Loading doctors...</div>
        } @else if (doctors().length === 0) {
          <div class="empty-state">
            <span class="empty-icon">üïí</span>
            <h3>No Doctors Yet</h3>
            <p>Add a doctor first to set their availability.</p>
            <button class="btn btn-primary" (click)="setActiveTab('doctors'); openCreateDoctorModal()">Add Doctor</button>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Doctor</th>
                  <th>Department</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (doctor of doctors(); track doctor.doctorId) {
                  <tr>
                    <td>
                      <div class="doctor-info">
                        <div class="doctor-avatar">{{ doctor.name?.charAt(0) || 'D' }}</div>
                        <div>
                          <div class="doctor-name">Dr. {{ doctor.name }}</div>
                          <div class="doctor-qualification">{{ doctor.qualification || 'N/A' }}</div>
                        </div>
                      </div>
                    </td>
                    <td>{{ doctor.departmentName || 'Unassigned' }}</td>
                    <td>
                      <div class="action-buttons">
                        <button class="btn btn-sm btn-primary" (click)="openScheduleModal(doctor)">Manage Availability</button>
                      </div>
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      }

      <!-- Departments Tab -->
      @if (activeTab() === 'departments') {
        @if (isLoadingDepartments()) {
          <div class="loading-spinner">Loading departments...</div>
        } @else if (departments().length === 0) {
          <div class="empty-state">
            <span class="empty-icon">üè¢</span>
            <h3>No Departments Yet</h3>
            <p>Add your first department to organize your hospital</p>
            <button class="btn btn-primary" (click)="openCreateDepartmentModal()">Add Department</button>
          </div>
        } @else {
          <div class="departments-grid">
            @for (department of departments(); track department.departmentId) {
              <div class="department-card">
                <div class="department-header">
                  <h3 class="department-name">{{ department.name }}</h3>
                  <span class="department-status" [class.active]="department.isActive">
                    {{ department.isActive ? 'Active' : 'Inactive' }}
                  </span>
                </div>
                <p class="department-description">{{ department.description || 'No description available' }}</p>
                <div class="department-actions">
                  <button class="btn btn-sm btn-outline" (click)="openEditDepartmentModal(department)">Edit</button>
                  <button class="btn btn-sm btn-danger" (click)="deleteDepartment(department)">Delete</button>
                </div>
              </div>
            }
          </div>
        }
      }

      <!-- Appointments Tab -->
      @if (activeTab() === 'appointments') {
        @if (isLoadingAppointments()) {
          <div class="loading-spinner">Loading appointments...</div>
        } @else if (appointments().length === 0) {
          <div class="empty-state">
            <span class="empty-icon">üìÖ</span>
            <h3>No Appointments Found</h3>
            <p>Appointments for your hospital will appear here.</p>
          </div>
        } @else {
          <div class="table-container">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Doctor</th>
                  <th>Patient</th>
                  <th>Hospital</th>
                  <th>Status</th>
                  <th>Cancellation</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                @for (apt of appointments(); track apt.appointmentId) {
                  <tr>
                    <td>{{ apt.appointmentDate | date:'mediumDate' }}</td>
                    <td>{{ apt.appointmentTime }}</td>
                    <td>{{ apt.doctorName || apt.doctorId }}</td>
                    <td>{{ apt.patientName || apt.patientId }}</td>
                    <td>{{ apt.hospitalName || apt.hospitalId || '‚Äî' }}</td>
                    <td>
                      <span class="status-badge" [class.active]="apt.appointmentStatus === 'Scheduled'">
                        {{ apt.appointmentStatus }}
                      </span>
                    </td>
                    <td>
                      @if (apt.cancellationRequested) {
                        <div>
                          <div class="text-sm font-semibold text-orange-600">Requested</div>
                          @if (apt.cancellationReason) {
                            <div class="text-xs text-gray-600 dark:text-gray-300 mt-1 p-2 bg-gray-100 dark:bg-gray-800 rounded">
                              <strong>Reason:</strong> {{ apt.cancellationReason }}
                            </div>
                          }
                        </div>
                      } @else {
                        ‚Äî
                      }
                    </td>
                    <td>
                      @if (apt.cancellationRequested && apt.appointmentStatus === 'CancellationRequested') {
                        <div class="action-buttons">
                          <button class="btn btn-sm btn-primary" (click)="approveCancellation(apt)">Approve</button>
                          <button class="btn btn-sm btn-danger" (click)="rejectCancellation(apt)">Reject</button>
                        </div>
                      } @else {
                        ‚Äî
                      }
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      }
    </div>
  </main>
</div>

<!-- Doctor Modal -->
@if (showDoctorModal()) {
  <div class="modal-overlay" (click)="closeDoctorModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingDoctor() ? 'Edit Doctor' : 'Add New Doctor' }}</h2>
        <button class="close-btn" (click)="closeDoctorModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Doctor Name *</label>
          <input type="text" [(ngModel)]="doctorForm.name" placeholder="Dr. Full Name">
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Email *</label>
            <input type="email" [(ngModel)]="doctorForm.email" placeholder="doctor@example.com">
          </div>
          <div class="form-group">
            <label>Phone *</label>
            <input type="tel" [(ngModel)]="doctorForm.phone" placeholder="+1234567890">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Department *</label>
            <select [(ngModel)]="doctorForm.departmentId">
              <option value="">Select Department</option>
              @for (dept of departments(); track dept.departmentId) {
                <option [value]="dept.departmentId">{{ dept.name }}</option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>Qualification *</label>
            <input type="text" [(ngModel)]="doctorForm.qualification" placeholder="e.g., MBBS, MD">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>License Number *</label>
            <input type="text" [(ngModel)]="doctorForm.licenseNumber" placeholder="License number">
          </div>
          <div class="form-group">
            <label>Status *</label>
            <select [(ngModel)]="doctorForm.status">
              <option value="Active">Active</option>
              <option value="Inactive">Inactive</option>
              <option value="On Leave">On Leave</option>
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeDoctorModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveDoctor()" [disabled]="isSubmitting()">
          {{ isSubmitting() ? 'Saving...' : (editingDoctor() ? 'Update Doctor' : 'Add Doctor') }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Department Modal -->
@if (showDepartmentModal()) {
  <div class="modal-overlay" (click)="closeDepartmentModal()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ editingDepartment() ? 'Edit Department' : 'Add New Department' }}</h2>
        <button class="close-btn" (click)="closeDepartmentModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label>Department Name *</label>
          <input type="text" [(ngModel)]="departmentForm.name" placeholder="e.g., Cardiology">
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea [(ngModel)]="departmentForm.description" placeholder="Brief description of the department..." rows="3"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeDepartmentModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveDepartment()" [disabled]="isSubmitting()">
          {{ isSubmitting() ? 'Saving...' : (editingDepartment() ? 'Update' : 'Create Department') }}
        </button>
      </div>
    </div>
  </div>
}

<!-- Schedule Modal -->
@if (showScheduleModal()) {
  <div class="modal-overlay" (click)="closeScheduleModal()">
    <div class="modal modal-lg" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Manage Schedule - Dr. {{ selectedDoctorForSchedule()?.name }}</h2>
        <button class="close-btn" (click)="closeScheduleModal()">√ó</button>
      </div>
      <div class="modal-body">
        <!-- Add New Schedule -->
        <div class="schedule-form">
          <h3>Add New Schedule</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Day of Week</label>
              <select [(ngModel)]="scheduleForm.dayOfWeek">
                @for (day of daysOfWeek; track day.value) {
                  <option [value]="day.value">{{ day.name }}</option>
                }
              </select>
            </div>
            <div class="form-group">
              <label>Start Time</label>
              <input type="time" [(ngModel)]="scheduleForm.startTime">
            </div>
            <div class="form-group">
              <label>End Time</label>
              <input type="time" [(ngModel)]="scheduleForm.endTime">
            </div>
            <div class="form-group">
              <label>Max Patients</label>
              <input type="number" [(ngModel)]="scheduleForm.maxPatients" min="1">
            </div>
          </div>
          <button class="btn btn-primary" (click)="addSchedule()" [disabled]="isSubmitting()">
            {{ isSubmitting() ? 'Adding...' : 'Add Schedule' }}
          </button>
        </div>

        <!-- Existing Schedules -->
        <div class="existing-schedules">
          <h3>Current Schedules</h3>
          @if (isLoadingSchedules()) {
            <div class="loading-spinner">Loading schedules...</div>
          } @else if (schedules().length === 0) {
            <p class="no-schedules">No schedules set for this doctor yet.</p>
          } @else {
            <div class="schedule-list">
              @for (schedule of schedules(); track schedule.scheduleId) {
                <div class="schedule-item">
                  <div class="schedule-day">{{ getDayName(schedule.dayOfWeek) }}</div>
                  <div class="schedule-time">{{ schedule.startTime }} - {{ schedule.endTime }}</div>
                  <div class="schedule-patients">Max: {{ schedule.maxPatients }} patients</div>
                  <button class="btn-icon btn-danger" (click)="deleteSchedule(schedule)">üóëÔ∏è</button>
                </div>
              }
            </div>
          }
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline" (click)="closeScheduleModal()">Close</button>
      </div>
    </div>
  </div>
}
