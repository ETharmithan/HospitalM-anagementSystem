<app-nav></app-nav>


<div class="dashboard-container">
  

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card upcoming">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().upcomingAppointments }}</span>
        <span class="stat-label">Upcoming Appointments</span>
      </div>
    </div>
    <div class="stat-card completed">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().completedAppointments }}</span>
        <span class="stat-label">Completed</span>
      </div>
    </div>
    <div class="stat-card cancelled">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().cancelledAppointments }}</span>
        <span class="stat-label">Cancelled</span>
      </div>
    </div>
    <div class="stat-card total">
      <div class="stat-icon">üìä</div>
      <div class="stat-info">
        <span class="stat-value">{{ stats().totalAppointments }}</span>
        <span class="stat-label">Total Appointments</span>
      </div>
    </div>
  </div>

  <!-- Quick Actions -->
  <div class="quick-actions">
    <h2>Quick Actions</h2>
    <div class="action-buttons">
      <button class="action-btn" routerLink="/doctors">
        <span class="action-icon">üë®‚Äç‚öïÔ∏è</span>
        <span>Find a Doctor</span>
      </button>
      <button class="action-btn" routerLink="/hospitals">
        <span class="action-icon">üè•</span>
        <span>View Hospitals</span>
      </button>
      <button class="action-btn" routerLink="/chat">
        <span class="action-icon">üí¨</span>
        <span>Messages</span>
      </button>
      <button class="action-btn" (click)="setActiveTab('upcoming')">
        <span class="action-icon">üìã</span>
        <span>My Appointments</span>
      </button>

      <button class="action-btn" routerLink="/e-prescription">
        <span class="action-icon">üßæ</span>
        <span>My Prescriptions</span>
      </button>
    </div>
  </div>

  <div class="content-section" style="padding-top: 0;">
    <div class="prescription-card">
      <div class="prescription-card-header">
        <div>
          <h2 style="margin: 0;">Latest Prescription</h2>
          <p class="prescription-subtitle">Your most recent e-prescription</p>
        </div>
        <button class="btn btn-outline btn-sm" type="button" (click)="openPrescriptionHistory()">View all</button>
      </div>

      @if (isLoadingPrescriptions()) {
        <div class="loading-container small">
          <div class="spinner"></div>
          <p>Loading prescriptions...</p>
        </div>
      } @else {
        @if (!latestPrescription()) {
          <div class="empty-inline">
            <span class="empty-inline-icon">üßæ</span>
            <div>
              <div class="empty-inline-title">No prescriptions yet</div>
              <div class="empty-inline-text">When your doctor creates an e-prescription, it will appear here.</div>
            </div>
          </div>
        } @else {
          <div class="prescription-body">
            <div class="prescription-meta">
              <div class="meta-item">
                <div class="meta-label">Visit Date</div>
                <div class="meta-value">{{ latestPrescription()!.visitDate | date:'yyyy-MM-dd' }}</div>
              </div>
              <div class="meta-item">
                <div class="meta-label">Diagnosis</div>
                <div class="meta-value">{{ latestPrescription()!.diagnosis }}</div>
              </div>
            </div>

            <div class="prescription-text">
              <div class="meta-label">Prescription</div>
              <div class="prescription-box">{{ latestPrescription()!.prescription }}</div>
            </div>

            <div class="prescription-actions">
              <button class="btn btn-primary" type="button" (click)="downloadPrescription(latestPrescription()!)">Download</button>
              <button class="btn btn-outline" type="button" (click)="openPrescriptionHistory()">Open history</button>
            </div>
          </div>
        }
      }
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'upcoming'"
      (click)="setActiveTab('upcoming')">
      Upcoming Appointments
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'past'"
      (click)="setActiveTab('past')">
      Past Appointments
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'doctors'"
      (click)="setActiveTab('doctors')">
      Find Doctors
    </button>
    <button 
      class="tab-btn" 
      [class.active]="activeTab() === 'hospitals'"
      (click)="setActiveTab('hospitals')">
      Hospitals
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>Loading your dashboard...</p>
    </div>
  }

  <!-- Upcoming Appointments -->
  @if (!isLoading() && activeTab() === 'upcoming') {
    <div class="content-section">
      <div class="section-header">
        <h2>Upcoming Appointments</h2>
        <button class="btn btn-primary btn-sm" routerLink="/doctors">
          + Book New
        </button>
      </div>
      
      @if (upcomingAppointments().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üìÖ</span>
          <h3>No Upcoming Appointments</h3>
          <p>You don't have any scheduled appointments.</p>
          <button class="btn btn-primary" routerLink="/doctors">
            Book an Appointment
          </button>
        </div>
      } @else {
        <div class="appointments-list">
          @for (apt of upcomingAppointments(); track apt.appointmentId) {
            <div class="appointment-card">
              <div class="appointment-date-time">
                <div class="date">{{ formatDate(apt.appointmentDate) }}</div>
                <div class="time">{{ apt.appointmentTime }}</div>
              </div>
              <div class="appointment-info">
                <div class="doctor-name">
                  <strong>Doctor ID:</strong> {{ apt.doctorId }}
                </div>
                <span class="status-badge" [ngClass]="getStatusClass(apt.appointmentStatus)">
                  {{ apt.appointmentStatus }}
                </span>
              </div>
              <div class="appointment-actions">
                @if (apt.appointmentStatus === 'Scheduled' || apt.appointmentStatus === 'Pending') {
                  <button class="btn btn-danger btn-sm" (click)="cancelAppointment(apt)">
                    Cancel
                  </button>
                }
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Past Appointments -->
  @if (!isLoading() && activeTab() === 'past') {
    <div class="content-section">
      <h2>Past Appointments</h2>
      
      @if (pastAppointments().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üìã</span>
          <h3>No Past Appointments</h3>
          <p>Your appointment history will appear here.</p>
        </div>
      } @else {
        <div class="appointments-list">
          @for (apt of pastAppointments(); track apt.appointmentId) {
            <div class="appointment-card past">
              <div class="appointment-date-time">
                <div class="date">{{ formatDate(apt.appointmentDate) }}</div>
                <div class="time">{{ apt.appointmentTime }}</div>
              </div>
              <div class="appointment-info">
                <div class="doctor-name">
                  <strong>Doctor ID:</strong> {{ apt.doctorId }}
                </div>
                <span class="status-badge" [ngClass]="getStatusClass(apt.appointmentStatus)">
                  {{ apt.appointmentStatus }}
                </span>
              </div>
            </div>
          }
        </div>
      }
    </div>
  }

  <!-- Find Doctors -->
  @if (!isLoading() && activeTab() === 'doctors') {
    <div class="content-section">
      <div class="section-header">
        <h2>Available Doctors</h2>
        <a routerLink="/doctors" class="btn btn-outline btn-sm">View All</a>
      </div>
      
      @if (isLoadingDoctors()) {
        <div class="loading-container small">
          <div class="spinner"></div>
          <p>Loading doctors...</p>
        </div>
      } @else if (doctors().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üë®‚Äç‚öïÔ∏è</span>
          <h3>No Doctors Available</h3>
          <p>Please check back later.</p>
        </div>
      } @else {
        <div class="doctors-grid">
          @for (doctor of doctors().slice(0, 6); track doctor.doctorId) {
            <div class="doctor-card">
              <div class="doctor-avatar">
                {{ doctor.name.charAt(0) }}
              </div>
              <div class="doctor-info">
                <h3>{{ doctor.name }}</h3>
                <p class="qualification">{{ doctor.qualification }}</p>
                <p class="department">{{ doctor.departmentName || 'General' }}</p>
              </div>
              <div style="display: flex; gap: 0.5rem; width: 100%;">
                <button class="btn btn-primary btn-sm" (click)="bookAppointment(doctor.doctorId)" style="flex: 1;">
                  Book Now
                </button>
                <a [routerLink]="['/doctor-detail', doctor.doctorId]" class="btn btn-outline btn-sm" style="flex: 1;">
                  View Details
                </a>
              </div>
            </div>
          }
        </div>
        @if (doctors().length > 6) {
          <div class="view-more">
            <a routerLink="/doctors" class="btn btn-outline">
              View All {{ doctors().length }} Doctors
            </a>
          </div>
        }
      }
    </div>
  }

  <!-- Hospitals -->
  @if (!isLoading() && activeTab() === 'hospitals') {
    <div class="content-section">
      <h2>Available Hospitals</h2>
      
      @if (isLoadingHospitals()) {
        <div class="loading-container">
          <div class="spinner"></div>
          <p>Loading hospitals...</p>
        </div>
      } @else if (hospitals().length === 0) {
        <div class="empty-state">
          <span class="empty-icon">üè•</span>
          <h3>No Hospitals Available</h3>
          <p>Please check back later.</p>
        </div>
      } @else {
        <div class="doctors-grid">
          @for (hospital of hospitals(); track hospital.hospitalId) {
            <div class="doctor-card">
              <div class="doctor-avatar">
                üè•
              </div>
              <div class="doctor-info">
                <h3>{{ hospital.name }}</h3>
                <p class="qualification">{{ hospital.city }}, {{ hospital.state }}</p>
                <p class="department">{{ hospital.address }}</p>
                <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                  <div>üìû {{ hospital.phoneNumber }}</div>
                  <div>‚úâÔ∏è {{ hospital.email }}</div>
                </div>
              </div>
              <a [routerLink]="['/hospital-detail', hospital.hospitalId]" class="btn btn-primary btn-sm">
                View Details
              </a>
            </div>
          }
        </div>
      }
    </div>
  }
</div>
